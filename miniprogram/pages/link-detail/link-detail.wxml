<!--pages/link-detail/link-detail.wxml-->
<view class="page-container" wx:if="{{!loading && link}}">
  <!-- é“¾æ¥ä¿¡æ¯å¡ç‰‡ -->
  <view class="link-card">
    <image 
      wx:if="{{link.thumbnail}}" 
      class="thumbnail" 
      src="{{link.thumbnail}}" 
      mode="aspectFill"
    ></image>
    
    <view class="link-info">
      <text class="title">{{link.title || 'æ— æ ‡é¢˜'}}</text>
      <text class="description">{{link.description || 'æš‚æ— æè¿°'}}</text>
      
      <view class="meta">
        <text class="source">{{link.source === 'wechat_article' ? 'å…¬ä¼—å·æ–‡ç« ' : link.source === 'wechat_video' ? 'å¾®ä¿¡è§†é¢‘' : 'å¤–éƒ¨é“¾æ¥'}}</text>
        <text class="time">{{link.createTimeStr}}</text>
      </view>

      <view class="tags" wx:if="{{link.tags && link.tags.length > 0}}">
        <text class="tag" wx:for="{{link.tags}}" wx:key="*this">{{item}}</text>
      </view>

      <view class="category-row" wx:if="{{link.category}}">
        <text class="label">åˆ†ç±»ï¼š</text>
        <text class="category-tag">{{link.category}}</text>
      </view>

      <view class="summary" wx:if="{{link.summary}}">
        <text class="label">AI æ‘˜è¦ï¼š</text>
        <text class="summary-text">{{link.summary}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions">
      <view class="action-btn" bindtap="openLink">
        <text class="action-icon">ğŸ“‹</text>
        <text>å¤åˆ¶é“¾æ¥</text>
      </view>
      <view class="action-btn" bindtap="openInBrowser">
        <text class="action-icon">ğŸ”—</text>
        <text>æ‰“å¼€</text>
      </view>
      <view class="action-btn {{link.isFavorite ? 'active' : ''}}" bindtap="toggleFavorite">
        <text class="action-icon">{{link.isFavorite ? 'â­' : 'â˜†'}}</text>
        <text>{{link.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
      </view>
      <view class="action-btn delete" bindtap="deleteLink">
        <text class="action-icon">ğŸ—‘ï¸</text>
        <text>åˆ é™¤</text>
      </view>
    </view>
  </view>

  <!-- AI æ·±åº¦è§£è¯»åŒºåŸŸ -->
  <view class="ai-insight-section">
    <view class="section-header">
      <text class="section-title">ğŸ¤– AI æ·±åº¦è§£è¯»</text>
      <view
        wx:if="{{!link.aiInsight && !generatingInsight}}"
        class="generate-btn"
        bindtap="generateInsight"
      >
        <text class="generate-icon">âœ¨</text>
        <text>ç”Ÿæˆè§£è¯»</text>
      </view>
    </view>

    <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
    <view wx:if="{{generatingInsight}}" class="insight-loading">
      <text class="loading-icon">â³</text>
      <text class="loading-text">AI æ­£åœ¨æ·±åº¦åˆ†æä¸­...</text>
    </view>

    <!-- AI è§£è¯»å†…å®¹ -->
    <view wx:if="{{link.aiInsight && !generatingInsight}}" class="insight-content">
      <!-- æ ¸å¿ƒè§‚ç‚¹ -->
      <view wx:if="{{link.aiInsight.keyPoints && link.aiInsight.keyPoints.length > 0}}" class="insight-block">
        <view class="block-title">ğŸ“ æ ¸å¿ƒè§‚ç‚¹</view>
        <view class="key-points">
          <view
            wx:for="{{link.aiInsight.keyPoints}}"
            wx:key="index"
            class="key-point-item"
          >
            <view class="point-header">
              <text class="point-number">{{index + 1}}</text>
              <text class="point-title">{{item.title}}</text>
            </view>
            <text class="point-content">{{item.content}}</text>
          </view>
        </view>
      </view>

      <!-- æ·±åº¦æ´å¯Ÿ -->
      <view wx:if="{{link.aiInsight.insights}}" class="insight-block">
        <view class="block-title">ğŸ’¡ æ·±åº¦æ´å¯Ÿ</view>
        <view class="insights-grid">
          <view wx:if="{{link.aiInsight.insights.value}}" class="insight-item">
            <text class="insight-label">æ ¸å¿ƒä»·å€¼</text>
            <text class="insight-text">{{link.aiInsight.insights.value}}</text>
          </view>
          <view wx:if="{{link.aiInsight.insights.inspiration}}" class="insight-item">
            <text class="insight-label">å¯å‘æ€è€ƒ</text>
            <text class="insight-text">{{link.aiInsight.insights.inspiration}}</text>
          </view>
          <view wx:if="{{link.aiInsight.insights.application}}" class="insight-item">
            <text class="insight-label">åº”ç”¨åœºæ™¯</text>
            <text class="insight-text">{{link.aiInsight.insights.application}}</text>
          </view>
          <view wx:if="{{link.aiInsight.insights.connection}}" class="insight-item">
            <text class="insight-label">çŸ¥è¯†å…³è”</text>
            <text class="insight-text">{{link.aiInsight.insights.connection}}</text>
          </view>
        </view>
      </view>

      <!-- æ€è€ƒé—®é¢˜ -->
      <view wx:if="{{link.aiInsight.questions && link.aiInsight.questions.length > 0}}" class="insight-block">
        <view class="block-title">ğŸ¤” æ€è€ƒé—®é¢˜</view>
        <view class="questions-list">
          <view
            wx:for="{{link.aiInsight.questions}}"
            wx:key="index"
            class="question-item"
            data-question="{{item}}"
            bindtap="onQuestionTap"
          >
            <text class="question-icon">ğŸ’­</text>
            <text class="question-text">{{item}}</text>
          </view>
        </view>
        <view class="tip-text">ğŸ’¡ ç‚¹å‡»é—®é¢˜å¯å¿«é€Ÿæ·»åŠ åˆ°ç‚¹è¯„ä¸­</view>
      </view>

      <!-- é™çº§æç¤º -->
      <view wx:if="{{link.aiInsight.modelVersion === 'fallback'}}" class="fallback-tip">
        <text>âš ï¸ AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä»¥ä¸Šä¸ºåŸºç¡€åˆ†æ</text>
      </view>
    </view>
  </view>

  <!-- ç‚¹è¯„åŒºåŸŸ -->
  <view class="comment-section">
    <view class="section-header">
      <text class="section-title">æˆ‘çš„ç‚¹è¯„</text>
      <view
        wx:if="{{link.aiInsight && !loadingSuggestions}}"
        class="assist-btn"
        bindtap="getCommentSuggestions"
      >
        <text class="assist-icon">âœ¨</text>
        <text>AI è¾…åŠ©</text>
      </view>
    </view>
    
    <!-- è¯„åˆ† -->
    <view class="rating-row">
      <text class="label">è¯„åˆ†ï¼š</text>
      <view class="rating-stars">
        <view 
          wx:for="{{[1,2,3,4,5]}}" 
          wx:key="*this"
          class="star {{rating >= item ? 'active' : ''}}"
          data-rating="{{item}}"
          bindtap="onRatingChange"
        >
          {{rating >= item ? 'â˜…' : 'â˜†'}}
        </view>
      </view>
    </view>

    <!-- ç‚¹è¯„å†…å®¹ -->
    <view class="comment-input-wrap">
      <textarea 
        class="comment-input"
        placeholder="å†™ä¸‹ä½ å¯¹è¿™ä¸ªé“¾æ¥çš„æƒ³æ³•..."
        value="{{commentContent}}"
        bindinput="onCommentInput"
        maxlength="500"
      ></textarea>
      <text class="char-count">{{commentContent.length}}/500</text>
    </view>

    <button class="save-btn" bindtap="saveComment">ä¿å­˜ç‚¹è¯„</button>

    <!-- AI ç‚¹è¯„å»ºè®®å¼¹çª— -->
    <view wx:if="{{showSuggestions}}" class="suggestions-modal" catchtap="closeSuggestions">
      <view class="suggestions-content" catchtap="stopPropagation">
        <view class="modal-header">
          <text class="modal-title">ğŸ’¡ AI ç‚¹è¯„å»ºè®®</text>
          <text class="close-btn" bindtap="closeSuggestions">âœ•</text>
        </view>

        <!-- åŠ è½½ä¸­ -->
        <view wx:if="{{loadingSuggestions}}" class="suggestions-loading">
          <text class="loading-icon">â³</text>
          <text class="loading-text">AI æ­£åœ¨ç”Ÿæˆå»ºè®®...</text>
        </view>

        <!-- å»ºè®®åˆ—è¡¨ -->
        <view wx:if="{{!loadingSuggestions && commentSuggestions.length > 0}}" class="suggestions-list">
          <view
            wx:for="{{commentSuggestions}}"
            wx:key="index"
            class="suggestion-card"
            data-content="{{item.content}}"
            bindtap="selectSuggestion"
          >
            <view class="suggestion-header">
              <text class="suggestion-icon">{{item.icon}}</text>
              <text class="suggestion-angle">{{item.angle}}</text>
            </view>
            <text class="suggestion-content">{{item.content}}</text>
            <view class="suggestion-action">
              <text class="action-text">ç‚¹å‡»ä½¿ç”¨æ­¤å»ºè®®</text>
            </view>
          </view>

          <view wx:if="{{suggestionsFallback}}" class="fallback-tip">
            <text>âš ï¸ AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä»¥ä¸Šä¸ºåŸºç¡€å»ºè®®</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading" wx:if="{{loading}}">
  <text>åŠ è½½ä¸­...</text>
</view>
